## 第六章 TCP与UDP

### 传输层的作用

TCP：面向连接的、可靠的流协议。流就是指不间断的数据结构，你可以把它想象成排水管道中的水流。当应用程序采用TCP发送消息时，虽然可以保证发送的顺序，但还是犹如没有任何间隔的数据流发送给接收端。

UDP：不具有可靠性的数据报协议。在UDP下，虽然可以确保发送消息的大小，但却不能保证消息一定会到达。因此，，应用有时会根据自己的需要进行重发处理。

**套接字（Socket）**

要使用TCP、UDP通信，广泛使用封装好的套接字（Socket）API。套接字原本是由BSD UNIX开发的，后来也移植到了Windows及嵌入式操作系统中。

### 端口号

端口号用来识别同一台计算机中进行通信的不同应用程序。因此，它也被成为程序地址。

一台计算机上同时运行多个程序。例如接受WWW服务的Web浏览器、电邮客户端、远程登录用的ssh客户端等都可同时运行。传输层协议正式利用这些端口号识别本机中正在通信的应用程序，并准确地将数据传输。

仅凭目标端口号识别某一个通信是远远不够的。因此，TCP/IP或UDP/IP通信中通常采用5给信息来识别一个通信。他们分别是：“源IP地址”、“目标IP地址”、“协议号”、“源端口号”、“目标端口号”。

<div>
    <image src="../res/img/tcpudp.png"></image>
</div>

### UDP

UDP是User Datagram Protocol（用户数据报协议）的缩写。

由于UDP面向无连接，它可以随时发生数据。再加上UDP本身的处理既简单又高效，因此经常用于以下几方面：

- 包总量较少的通信（DNS、SNMP等）
- 视频、音频等多媒体通信（即时通信）
- 限定于LAN等特定网络中的应用通信
- 广播通信（广播、多播）

### TCP

#### TCP的特点及其目的

Transmission Control Protocol 传输控制协议

TCP与UDP的区别相当大。它充分地实现了数据传输时各种控制功能。可以进行丢包时的重发控制，还可以对次序乱掉的分包进行顺序控制。TCP通过检验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠性传输。

#### 通过序列号与确认应答提高可靠性

在TCP中，当发送端的数据到达接收主机时，接收端主机会返回一个已收到消息的通知。这个消息叫做确认应答（ACK，即Positive Acknowledgement意指已经接收）。

未收到确认应答并不意味着数据一定丢失。也可能是数据对方已经接收，但是返回的确认应答在途中丢失。

确认应答、重发控制以及重复控制等功能通过序列号实现。序列号是按顺序发给数据的每一个字节都编上号码的编号。

#### 重发超时如何确定

重发超时是指在重发数据之前，等待确认应答到来的那个特定时间间隔。

在BSD的Unix以及Windows系统中，超时都是以0.5秒为单位进行控制，因此重发超时都是0.5秒的整数倍。数据被重发之后若还是收不到确认应答，则进行再次重发。此时，等待确认应答的时间将会以2倍、4倍的指数函数延长。

数据并不会被无限、反复地重发。达到一定重发次数之后，如果仍然没有任何确认应答返回，则会判断为网络或对端主机发生异常，强制关闭连接。

#### 连接管理

UDP在通信是不会检查对端是否可以通信，直接将UDP包发送出去。TCP与此相反，它会在数据通信之前，通过TCP首部发送一个SYN包作为建立连接的请求等待确认应答。如果对端发来确认应答，则认为可以进行通信，如果对方的确认应答未达到，则不会进行数据通信。

<div>
    <image src="../res/img/tcpconnect.png"></image>
</div>

#### TCP以段为单位发送数据

TCP在传输数据时，是以MSS（最大消息长度）的大小将数据进行分割发送，进行重发时也以MSS为单位。

Mss是在三次握手时，在两端主机之间被计算得出。两端的主机在发出建立连接请求时，会在TCP首部写入MSS选项，然后会在两者之间选择一个较小的值投入使用。

#### 利用窗口控制提高速度